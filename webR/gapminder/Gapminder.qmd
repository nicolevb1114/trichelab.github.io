---
title: "Rmarkdown: Gapminder"
author: "Tim Triche, Jr."
format: 
  html:
    toc: true
engine: knitr
execute:
  warning: false
filters:
  - webr
webr:
  packages: ['gapminder','dplyr','ggplot2']
---

# Mind the gaps

The Gapminder dataset comes from a popular TED talk by Hans Rosling, 
which you can view <a href="https://www.youtube.com/watch?v=hVimVzgtD6w">here</a> if you like. The Roslings compiled actuarial records of life expectancy,
income, and population size for countries around the world over many years.

Hans passed away in 2017, but the impact of his work remains, partly because the
<a href="https://www.gapminder.org/about/about-gapminder/history/">Gapminder 
foundation</a> helps keep the data and tools from the talk available and usable.

You too can become immortal in this way. The first step is to make your data and
analyses reproducible, so that other people can understand and build upon them.
Let's use Rosling's data for an example of how to do so. If you want to peek
at the <a href="https://github.com/trichelab/trichelab.github.io/blob/gh-pages/webR/gapminder/Gapminder.qmd">markdown document itself</a>, please do!


## The gapminder data

An excerpt of the data from Rosling's talk is available in R via the
<a href="https://cran.r-project.org/package=gapminder">`gapminder`</a>
package, which can be installed from CRAN via `install.packages("gapminder")`.
We can also check which version of the package was installed:

```{webr-r}
install.packages("gapminder")
library("gapminder")
paste("gapminder", packageVersion("gapminder"))
```

It's a good idea to keep track of versions, in case something were to change.
When this document was compiled, the version was 
`paste("gapminder", packageVersion("gapminder"))`.


## A quick look

Let's take a quick look at the `gapminder` data itself. If you type the name
of a data object into R, you will (almost always) get a glimpse of the data:

```{r}
#| label: Quick look 
library("gapminder")
gapminder
```

This isn't necessarily an ideal way to inspect a dataset.  The `head` and `tail`
functions in R can be helpful when a dataset is too big to digest in one shot. 
What happens when you call these functions on the `gapminder` dataset?

```{webr-r}
library("gapminder")
head(gapminder)
tail(gapminder)
```

## Plotting with ggplot2

Earlier in the workshop, you plotted some of the gapminder data with `ggplot2`:

```{r}
#| label: A faceted plot

library("gapminder") 
americas <- gapminder[gapminder$continent == "Americas",]

library("ggplot2")
ggplot(data = americas, 
       mapping = aes(x = year, 
                     y = lifeExp, 
                     color = continent)) +
  geom_line() + 
  facet_wrap( ~ country) +
  labs(
    x = "Year",              # x axis title
    y = "Life expectancy",   # y axis title
    title = "Figure 1",      # main title of figure
    color = "Continent"      # title of legend
  ) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))  

```

However, if you have seen Rosling's talk, you may recall a particular style 
of plot (the "bubble plot") used to great impact.  Can we recreate that plot?


## A bubble plot

Let's plot the relationships between life expectancy and gross domestic product
with the size of the dots representing the population of a country in millions.
We will start by doing this for the year 2007, like Rosling did. (We have data 
from `nrow(subset(gapminder, year == "2007"))` countries in 2007.) We will use
the included `continent_colors` from the `gapminder` package to standardize the
fill colors (it is a good idea to standardize colors when making plots so that 
your audience can expect for a given color to mean the same thing all the time).

```{r}
#| label: 2007 bubble plot

library("gapminder")
library("ggplot2")
ggplot(subset(gapminder, 
              year == "2007"), 
       aes(x = gdpPercap, 
           y = lifeExp, 
           size = pop,
           fill = continent)) + 
  geom_point(alpha=0.5, shape=21, color="black") +
  scale_size(range = c(.1, 24), name="Population (M)") +
  scale_fill_manual(values = continent_colors) + 
  labs(y = "Life Expectancy (years)", 
       x = "GDP per Capita (US$)") +
  guides(size = FALSE, fill = FALSE) + 
  theme_classic() 

```

### Challenge

Suppose you wanted to look at a different year's worth of data (say, 1952), or
a specific continent (for example, Asia). Can you modify the code so that it
plots only the data you are interested in seeing?

```{webr-r}

library("gapminder")
library("ggplot2")

ggplot(subset(gapminder, 
              year == "2007"), 
       aes(x = gdpPercap, 
           y = lifeExp, 
           size = pop,
           fill = continent)) + 
  geom_point(alpha=0.5, shape=21, color="black") +
  scale_size(range = c(.1, 24), name="Population (M)") +
  scale_fill_manual(values = continent_colors) + 
  labs(y = "Life Expectancy (years)", 
       x = "GDP per Capita (US$)") +
  guides(size = FALSE, fill = FALSE) + 
  theme_classic()

```
